#!/usr/bin/env ruby
# frozen_string_literal: true

Process.setproctitle("tb_bot")
File.open("./tmp/bot.pid", "w") do |f|
  f << Process.pid
end

require './application'

$logger = $app_config.load_logger
$logger.debug 'Starting telegram bot'

$app_config.tg_bot_client.run do |bot|
  Thread.report_on_exception = true
  bot.listen do |rqst|
    thread = Thread.new(rqst) do |message|
      p "HERE MAIN"
      if message.respond_to?(:data)
        $logger.debug "#{message.from.id} - @#{message.from.username}: #{message.data}"
      else
        $logger.debug "#{message.from.id} - @#{message.from.username}: #{message}"
      end
      context = MessageResponder.new(bot: bot, message: message)
      strategy = context.handle
      I18n.with_locale context.settings.localization.to_sym do
        strategy.do_action
      end
    end
    thread.join
  rescue => e
    $logger.debug "Error: #{e}."
  end
end